<!DOCTYPE html>



<html lang="en" itemscope="" itemtype="http://schema.org/QAPage">

<!-- Mirrored from c.programmingpedia.net/en/knowledge-base/6988487/what-does-the-brk---system-call-do- by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Jan 2021 10:13:09 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <!-- webmaster tools -->
        <meta name="google-site-verification" content="" />
        <!-- Open Graph Tags -->
        <meta name="title" property="og:title" content="[SOLVED] What does the brk() system call do? | C Language Knowledge Base">
        <meta name="description" property="og:description" content="[SOLVED] What does the brk() system call do? | C Language Knowledge Base">
        <title>[SOLVED] What does the brk() system call do? | C Language Knowledge Base</title>

    

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    
        <style>
            body{margin:0;}img{max-width:100%;}ul{margin-top:0;margin-bottom:1rem;}.list-inline{padding-left:0;list-style:none;}.list-inline-item{display:inline-block;}.list-inline-item:not(:last-child){margin-right:.5rem;}.site-header{display:flex;height:60px;}.site-main,.site-footer{display:flex;}.col-aside-left-and-sidebar .col-aside-left,.col-sidebar,.col-content,.col-aside-right{position:relative;}.site-header .col-aside-left-and-sidebar-inner,.site-header .col-aside-right-inner,.site-header .col-content-inner{height:60px;}.site-header .col-aside-left-and-sidebar-inner,.site-header .col-aside-right-inner{position:fixed;z-index:1;}.site-main .col-aside-left-inner,.site-main .col-sidebar-inner,.site-main .col-aside-right-inner{height:calc(100vh - 60px);position:fixed;}.site-main .col-sidebar-overflow{height:calc(100vh - 60px);position:relative;overflow-x:hidden;overflow-y:auto;}.col-aside-left-and-sidebar,.col-aside-left-and-sidebar-inner{width:calc(50% - 450px);}.col-aside-left,.col-aside-left-inner{width:calc(50% - 750px);}.col-sidebar,.col-sidebar-inner{width:300px;}.col-content,.col-content-inner{width:1200px;}.col-aside-right,.col-aside-right-inner{width:calc(50% - 750px);}@media(max-width:1869px){.col-aside-left-and-sidebar,.col-aside-left-and-sidebar-inner{width:calc(50% - 500px);}.col-aside-left,.col-aside-left-inner{display:none;}.col-sidebar,.col-sidebar-inner{width:calc(50% - 500px);}.col-content,.col-content-inner{width:1000px;}.col-aside-right,.col-aside-right-inner{width:calc(50% - 500px);}}@media(max-width:1549px){.col-aside-left-and-sidebar,.col-aside-left-and-sidebar-inner{width:calc(50% - 400px);}.col-sidebar,.col-sidebar-inner{width:calc(50% - 400px);}.col-content,.col-content-inner{width:800px;}.col-aside-right,.col-aside-right-inner{width:calc(50% - 400px);}}@media(max-width:1229px){.col-aside-left-and-sidebar,.col-aside-left-and-sidebar-inner{width:300px;}.col-sidebar,.col-sidebar-inner{width:300px;}.col-content{width:calc(100% - 300px);}.col-content-inner{width:100%;}.col-aside-right,.col-aside-right-inner{display:none;}}@media(max-width:1000px){.col-aside-left-and-sidebar,.col-aside-left-and-sidebar-inner{width:250px;}.col-sidebar,.col-sidebar-inner{width:250px;}.col-content{width:calc(100% - 250px);}}@media(max-width:767px){.col-aside-left-and-sidebar,.col-aside-left-and-sidebar-inner{display:none;}.col-sidebar,.col-sidebar-inner{display:none;}.col-content{width:100%;}.site-main{display:initial;}.site-main .col-sidebar,.site-main .col-sidebar-inner{display:initial;width:100%;position:relative;}.site-main .col-sidebar-overflow{height:calc(30vh);}}.site-header .col-aside-left-and-sidebar-inner,.site-header .col-aside-right-inner,.site-header .col-content-inner{box-shadow:rgba(116,129,141,.1) 0 3px 8px 0;border-bottom:1px solid #d4dadf;}.site-header .col-aside-left-and-sidebar-inner,.site-header .col-aside-right-inner,.site-main .col-aside-left-inner,.site-main .col-sidebar-inner,.site-main .col-aside-right-inner{background:#f5f7f9 none repeat scroll 0% 0%;}.site-header .col-aside-left-and-sidebar-inner,.site-main .col-sidebar-inner{border-right:1px solid #e6ecf1;}.site-header .col-aside-right,.site-main .col-aside-right{border-left:1px solid #e6ecf1;}.brand{font-size:24px;font-weight:bold;height:100%;text-align:right;margin-right:20px;margin-top:10px;}
        </style>
    <link rel="stylesheet" type="text/css" href="../../../styles/master.min0e4d.css?v=todo">
    <!-- to fix/move? -->
    

    
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-55584370-32"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-131737769-1');
    </script>


</head>
<body>


<div class="site-header">
    <div class="col-aside-left-and-sidebar">
        <div class="col-aside-left-and-sidebar-inner">
            <div class="brand">
                <i class="fas fa-yin-yang" style="color: #0056b3;"></i>&nbsp;
                C Language Pedia
            </div>
        </div>
    </div>
    <div class="col-content">
        <div class="col-content-inner">
<div>
    <ul class="list-inline">
        <li class="list-inline-item"><a href="../../../index.html">Tutorial</a></li>
            <li class="list-inline-item"><a href="../../knowledge-base.html">Knowledge-Base</a></li>

            <li class="list-inline-item"><a href="../../awesome-learning/book.html">Awesome</a></li>
    </ul>
</div>

<style>
    .site-header .col-content .list-inline {
        padding-left: 20px;
        padding-top: 15px;

        font-weight: bold;
    }
</style>
        </div>
    </div>
    <div class="col-aside-right">
        <div class="col-aside-right-inner">
            
        </div>
    </div>
</div>
<div class="site-main">
    <div class="col-aside-left">
        <div class="col-aside-left-inner">
            
        </div>
    </div>
    <div class="col-sidebar">
        <div class="col-sidebar-inner">

            <div class="col-sidebar-overflow">
                
            </div>

        </div>
    </div>
    <div class="col-content">
        <div class="col-content-inner">
            


<div id="knowledge-base" class="kb-details">
    <div class="row">
        <div class="col-lg-1 col-xl-1">
        </div>
        <div class="col-lg-9 col-xl-9" itemprop="mainEntity" itemscope itemtype="http://schema.org/Question">
            <div class="container-h1">
                <h1 itemprop="name" id="what-does-the-brk-system-call-do-">What does the brk() system call do?</h1>
                <div class="tag-list">
                        <span class="tag-item"><a href="../tag/brk.html">brk</a></span>
                        <span class="tag-item"><a href="../tag/c.html">c</a></span>
                        <span class="tag-item"><a href="../tag/linux.html">linux</a></span>
                        <span class="tag-item"><a href="../tag/memory-management.html">memory-management</a></span>
                        <span class="tag-item"><a href="../tag/unix.html">unix</a></span>
                </div>
            </div>
            <br>
            <div class="search-results-container">
                <div class="row">
                    <div class="col-sm-6">
                        <div class="block-question">
                            <div class="container-question">
                                <i class="fab fa-stack-overflow" style="font-size: 32px; position: absolute; left: -15px; top: -15px;"></i>
                                <h3 id="question">Question</h3>
                                <div itemprop="text">
                                    <p>According to Linux programmers manual: </p>

<blockquote>
  <p>brk() and sbrk() change the location of the program break, which
  defines the end of the process's data segment.</p>
</blockquote>

<p>What does the data segment mean over here? Is it just the data segment or data, BSS, and heap combined? </p>

<p>According to wiki: </p>

<blockquote>
  <p>Sometimes the data, BSS, and heap areas are collectively referred to as the "data segment".</p>
</blockquote>

<p>I see no reason for changing the size of just the data segment. If it is data, <a href="https://en.wikipedia.org/wiki/.bss" rel="nofollow noreferrer">BSS</a> and heap collectively then it makes sense as heap will get more space.</p>

<p>Which brings me to my second question. In all the articles I read so far, author says that heap grows upward and stack grows downward. But what they do not explain is what happens when heap occupies all the space between heap and stack? </p>

<p><img src="https://i.stack.imgur.com/1aV6B.png" alt="enter image description here"></p>

                                </div>

                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="profile-container">
                                        <div class="profile-details-container d-flex align-items-center">
                                            <div class="asker-name" itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="https://stackoverflow.com/users/246095/nik" target="_blank"><span itemprop="name">nik</span></a></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: none">
                                    <div itemprop="answerCount">1</div>
                                    <div itemprop="upvoteCount">165</div>
                                    <div itemprop="dateCreated">8/4/2019 10:46:11 AM</div>
                                </div>
                            </div>
                        </div>
                        
                        <br/>
                    </div>
                    <div class="col-sm-6">
                            <div id="answer-0" class="block-question answer" itemprop="acceptedAnswer" itemscope itemtype="http://schema.org/Answer">
                                <div class="container-question">
                                    <h3 id="accepted-answer">Accepted Answer</h3>
                                    <div itemprop="text">
                                        <p>In the diagram you posted, the "break"—the address manipulated by <code>brk</code> and <code>sbrk</code>—is the dotted line at the top of the heap.</p>

<p><img src="https://i.stack.imgur.com/1aV6B.png" alt="simplified image of virtual memory layout"></p>

<p>The documentation you've read describes this as the end of the "data segment" because in traditional (pre-shared-libraries, pre-<code>mmap</code>) Unix the data segment was continuous with the heap; before program start, the kernel would load the "text" and "data" blocks into RAM starting at address zero (actually a little above address zero, so that the NULL pointer genuinely didn't point to anything) and set the break address to the end of the data segment.  The first call to <code>malloc</code> would then use <code>sbrk</code> to move the break up and create the heap <em>in between</em> the top of the data segment and the new, higher break address, as shown in the diagram, and subsequent use of <code>malloc</code> would use it to make the heap bigger as necessary.</p>

<p>Meantime, the stack starts at the top of memory and grows down.  The stack doesn't need explicit system calls to make it bigger; either it starts off with as much RAM allocated to it as it can ever have (this was the traditional approach) or there is a region of reserved addresses below the stack, to which the kernel automatically allocates RAM when it notices an attempt to write there (this is the modern approach).  Either way, there may or may not be a "guard" region at the bottom of the address space that can be used for stack.  If this region exists (all modern systems do this) it is permanently unmapped; if <em>either</em> the stack or the heap tries to grow into it, you get a segmentation fault.  Traditionally, though, the kernel made no attempt to enforce a boundary; the stack could grow into the heap, or the heap could grow into the stack, and either way they would scribble over each other's data and the program would crash.  If you were very lucky it would crash immediately.</p>

<p>I'm not sure where the number 512GB in this diagram comes from.  It implies a 64-bit virtual address space, which is inconsistent with the very simple memory map you have there.  A real 64-bit address space looks more like this:</p>

<p><img src="https://i.stack.imgur.com/RQxMY.png" alt="less simplified address space"></p>

<pre><code>              Legend:  t: text, d: data, b: BSS
</code></pre>

<p>This is not remotely to scale, and it shouldn't be interpreted as exactly how any given OS does stuff (after I drew it I discovered that Linux actually puts the executable much closer to address zero than I thought it did, and the shared libraries at surprisingly high addresses). The black regions of this diagram are unmapped -- any access causes an immediate segfault -- and they are <em>gigantic</em> relative to the gray areas. The light-gray regions are the program and its shared libraries (there can be dozens of shared libraries); each has an <em>independent</em> text and data segment (and "bss" segment, which also contains global data but is initialized to all-bits-zero rather than taking up space in the executable or library on disk).  The heap is no longer necessarily continous with the executable's data segment -- I drew it that way, but it looks like Linux, at least, doesn't do that.  The stack is no longer pegged to the top of the virtual address space, and the distance between the heap and the stack is so enormous that you don't have to worry about crossing it.</p>

<p>The break is still the upper limit of the heap.  However, what I didn't show is that there could be dozens of independent allocations of memory off there in the black somewhere, made with <code>mmap</code> instead of <code>brk</code>.  (The OS will try to keep these far away from the <code>brk</code> area so they don't collide.)</p>

                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="profile-container">
                                            <div class="profile-details-container d-flex align-items-center">
                                                    <div class="asker-name" itemprop="author" itemscope itemtype="https://schema.org/Person">
                                                        <a href="https://stackoverflow.com/users/388520/zwol" target="_blank"><span itemprop="name">zwol</span></a>
                                                    </div>
                                            </div>
                                        </div>
                                    </div>
                                        <div style="display: none">
                                            <div itemprop="url">https://c.programmingpedia.net/en/knowledge-base/6988487/what-does-the-brk---system-call-do-#answer-0</div>
                                            <div itemprop="upvoteCount">214</div>
                                            <div itemprop="dateCreated">8/4/2019 10:48:18 AM</div>
                                        </div>
                                </div>
                            </div>
                            <br/>
                            <div id="answer-1" class="block-question second-answer" >
                                <div class="container-question">
                                    <h3 id="popular-answer">Popular Answer</h3>
                                    <div >
                                        <p><strong>Minimal runnable example</strong></p>

<blockquote>
  <p>What does brk( ) system call do?</p>
</blockquote>

<p>Asks the kernel to let you you read and write to a contiguous chunk of memory called the heap.</p>

<p>If you don't ask, it might segfault you.</p>

<p>Without <code>brk</code>:</p>

<pre><code>#define _GNU_SOURCE
#include &lt;unistd.h&gt;

int main(void) {
    /* Get the first address beyond the end of the heap. */
    void *b = sbrk(0);
    int *p = (int *)b;
    /* May segfault because it is outside of the heap. */
    *p = 1;
    return 0;
}
</code></pre>

<p>With <code>brk</code>:</p>

<pre><code>#define _GNU_SOURCE
#include &lt;assert.h&gt;
#include &lt;unistd.h&gt;

int main(void) {
    void *b = sbrk(0);
    int *p = (int *)b;

    /* Move it 2 ints forward */
    brk(p + 2);

    /* Use the ints. */
    *p = 1;
    *(p + 1) = 2;
    assert(*p == 1);
    assert(*(p + 1) == 2);

    /* Deallocate back. */
    brk(b);

    return 0;
}
</code></pre>

<p><a href="https://github.com/cirosantilli/linux-kernel-module-cheat/blob/d7a24ea2002547350e9b23f2a8f468b06dbd0836/userland/glibc/brk.c" rel="nofollow noreferrer">GitHub upstream</a>.</p>

<p>The above might not hit a new page and not segfault even without the <code>brk</code>, so here is a more aggressive version that allocates 16MiB and is very likely to segfault without the <code>brk</code>:</p>

<pre><code>#define _GNU_SOURCE
#include &lt;assert.h&gt;
#include &lt;unistd.h&gt;

int main(void) {
    void *b;
    char *p, *end;

    b = sbrk(0);
    p = (char *)b;
    end = p + 0x1000000;
    brk(end);
    while (p &lt; end) {
        *(p++) = 1;
    }
    brk(b);
    return 0;
}
</code></pre>

<p>Tested on Ubuntu 18.04.</p>

<p><strong>Virtual address space visualization</strong></p>

<p>Before <code>brk</code>:</p>

<pre><code>+------+ &lt;-- Heap Start == Heap End
</code></pre>

<p>After <code>brk(p + 2)</code>:</p>

<pre><code>+------+ &lt;-- Heap Start + 2 * sizof(int) == Heap End 
|      |
| You can now write your ints
| in this memory area.
|      |
+------+ &lt;-- Heap Start
</code></pre>

<p>After <code>brk(b)</code>:</p>

<pre><code>+------+ &lt;-- Heap Start == Heap End
</code></pre>

<p>To better understand address spaces, you should make yourself familiar with paging: <a href="https://stackoverflow.com/questions/18431261/how-does-x86-paging-work">How does x86 paging work?</a>.</p>

<p><strong>Why do we need both <code>brk</code> and <code>sbrk</code>?</strong></p>

<p><code>brk</code> could of course be implemented with <code>sbrk</code> + offset calculations, both exist just for convenience.</p>

<p>In the backend, the Linux kernel v5.0 has a single system call <code>brk</code> that is used to implement both: <a href="https://github.com/torvalds/linux/blob/v5.0/arch/x86/entry/syscalls/syscall_64.tbl#L23" rel="nofollow noreferrer">https://github.com/torvalds/linux/blob/v5.0/arch/x86/entry/syscalls/syscall_64.tbl#L23</a></p>

<pre><code>12  common  brk         __x64_sys_brk
</code></pre>

<p><strong>Is <code>brk</code> POSIX?</strong></p>

<p><code>brk</code> used to be POSIX, but it was removed in POSIX 2001, thus the need for <code>_GNU_SOURCE</code> to access the glibc wrapper.</p>

<p>The removal is likely due to the introduction <code>mmap</code>, which is a superset that allows multiple range to be allocated and more allocation options.</p>

<p>I think there is no valid case where you should to use <code>brk</code> instead of <code>malloc</code> or <code>mmap</code> nowadays.</p>

<p><strong><code>brk</code> vs <code>malloc</code></strong></p>

<p><code>brk</code> is one old possibility of implementing <code>malloc</code>.</p>

<p><code>mmap</code> is the newer stricly more powerful mechanism which likely all POSIX systems currently use to implement <code>malloc</code>.</p>

<p><strong>Can I mix <code>brk</code> and malloc?</strong></p>

<p>If your <code>malloc</code> is implemented with <code>brk</code>, I have no idea how that can possibly not blow up things, since <code>brk</code> only manages a single range of memory.</p>

<p>I could not however find anything about it on the glibc docs, e.g.:</p>

<ul>
<li><a href="https://www.gnu.org/software/libc/manual/html_mono/libc.html#Resizing-the-Data-Segment" rel="nofollow noreferrer">https://www.gnu.org/software/libc/manual/html_mono/libc.html#Resizing-the-Data-Segment</a></li>
</ul>

<p>Things will likely just work there I suppose since <code>mmap</code> is likely used for <code>malloc</code>.</p>

<p>See also:</p>

<ul>
<li><a href="https://stackoverflow.com/questions/55367809/whats-unsafe-legacy-about-brk-sbrk">What&#39;s unsafe/legacy about brk/sbrk?</a></li>
<li><a href="https://stackoverflow.com/questions/54294724/why-does-calling-sbrk0-twice-give-a-different-value">Why does calling sbrk(0) twice give a different value?</a></li>
</ul>

<p><strong>More info</strong></p>

<p>Internally, the kernel decides if the process can have that much memory, and earmarks <a href="https://stackoverflow.com/questions/18431261/how-does-x86-paging-work">memory pages</a> for that usage.</p>

<p>This explains how the stack compares to the heap: <a href="https://stackoverflow.com/questions/4584089/what-is-the-function-of-the-push-pop-instructions-used-on-registers-in-x86-ass/33583134#33583134">What is the function of the push / pop instructions used on registers in x86 assembly?</a></p>

                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="profile-container">
                                            <div class="profile-details-container d-flex align-items-center">
                                                    <div class="asker-name"><a href="https://stackoverflow.com/users/895245/ciro-santilli-------996icu----" target="_blank">Ciro Santilli 新疆改造中心996ICU六四事件</a></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br/>
                    </div>
                </div>
                <div class="text-center mt-5 mb-5">
                    <a href="https://stackoverflow.com/questions/6988487" class="btn-only d-inline-block stack-overflow-identity" target="_blank"><i class="fab fa-stack-overflow"></i> View more on Stack Overflow</a>
                </div>
            </div>
            
            <div class="attribution">
                <div>Licensed under: <a href="https://creativecommons.org/licenses/by-sa/3.0/" target="_blank">CC-BY-SA</a> with <a href="https://stackoverflow.blog/2009/06/25/attribution-required/" target="_blank">attribution</a></div>
                <div>Not affiliated with: <a href="https://stackoverflow.com/questions/tagged/dapper" target="_blank">Stack Overflow</a></div>
                
            </div>
        </div>

    </div>
</div>
            
        </div>
    </div>
    <div class="col-aside-right">
        <div class="col-aside-right-inner">
        </div>
    </div>
</div>
<div class="site-footer">
</div>
    
    <a href="#" id="scroll-to-top" class="back-to-top" style="display: inline;">Icon</a>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="http://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

<script>
    $(function() {
        $('a').each(function() {
            var a = new RegExp('/' + window.location.host + '/');
            if (!a.test(this.href)) {
                $(this).attr("target", "_blank");
            }
        });

        $("table").addClass("table table-bordered table-hover table-responsive-sm table-striped");
        $("thead").addClass("thead-dark");

        $('aside a').each(function() {
            if ($(this).attr('href') == '/{{page.permalink}}' ||
                $(this).attr('href') == '{{ site.github.url }}/{{page.permalink}}') {
                $(this).addClass('font-weight-bold');
            }
        });
    });
</script>


</body>

<!-- Mirrored from c.programmingpedia.net/en/knowledge-base/6988487/what-does-the-brk---system-call-do- by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Jan 2021 10:13:09 GMT -->
</html>
