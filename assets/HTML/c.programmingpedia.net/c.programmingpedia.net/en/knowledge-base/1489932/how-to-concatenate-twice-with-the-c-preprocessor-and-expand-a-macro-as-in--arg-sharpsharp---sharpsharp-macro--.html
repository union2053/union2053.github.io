<!DOCTYPE html>



<html lang="en" itemscope="" itemtype="http://schema.org/QAPage">

<!-- Mirrored from c.programmingpedia.net/en/knowledge-base/1489932/how-to-concatenate-twice-with-the-c-preprocessor-and-expand-a-macro-as-in--arg-sharpsharp---sharpsharp-macro-- by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Jan 2021 09:51:37 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <!-- webmaster tools -->
        <meta name="google-site-verification" content="" />
        <!-- Open Graph Tags -->
        <meta name="title" property="og:title" content="How to concatenate twice with the C preprocessor and expand a macro as in &quot;arg ## _ ## MACRO&quot;? | C Language Knowledge Base">
        <meta name="description" property="og:description" content="How to concatenate twice with the C preprocessor and expand a macro as in &quot;arg ## _ ## MACRO&quot;? | C Language Knowledge Base">
        <title>How to concatenate twice with the C preprocessor and expand a macro as in &quot;arg ## _ ## MACRO&quot;? | C Language Knowledge Base</title>

    

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    
        <style>
            body{margin:0;}img{max-width:100%;}ul{margin-top:0;margin-bottom:1rem;}.list-inline{padding-left:0;list-style:none;}.list-inline-item{display:inline-block;}.list-inline-item:not(:last-child){margin-right:.5rem;}.site-header{display:flex;height:60px;}.site-main,.site-footer{display:flex;}.col-aside-left-and-sidebar .col-aside-left,.col-sidebar,.col-content,.col-aside-right{position:relative;}.site-header .col-aside-left-and-sidebar-inner,.site-header .col-aside-right-inner,.site-header .col-content-inner{height:60px;}.site-header .col-aside-left-and-sidebar-inner,.site-header .col-aside-right-inner{position:fixed;z-index:1;}.site-main .col-aside-left-inner,.site-main .col-sidebar-inner,.site-main .col-aside-right-inner{height:calc(100vh - 60px);position:fixed;}.site-main .col-sidebar-overflow{height:calc(100vh - 60px);position:relative;overflow-x:hidden;overflow-y:auto;}.col-aside-left-and-sidebar,.col-aside-left-and-sidebar-inner{width:calc(50% - 450px);}.col-aside-left,.col-aside-left-inner{width:calc(50% - 750px);}.col-sidebar,.col-sidebar-inner{width:300px;}.col-content,.col-content-inner{width:1200px;}.col-aside-right,.col-aside-right-inner{width:calc(50% - 750px);}@media(max-width:1869px){.col-aside-left-and-sidebar,.col-aside-left-and-sidebar-inner{width:calc(50% - 500px);}.col-aside-left,.col-aside-left-inner{display:none;}.col-sidebar,.col-sidebar-inner{width:calc(50% - 500px);}.col-content,.col-content-inner{width:1000px;}.col-aside-right,.col-aside-right-inner{width:calc(50% - 500px);}}@media(max-width:1549px){.col-aside-left-and-sidebar,.col-aside-left-and-sidebar-inner{width:calc(50% - 400px);}.col-sidebar,.col-sidebar-inner{width:calc(50% - 400px);}.col-content,.col-content-inner{width:800px;}.col-aside-right,.col-aside-right-inner{width:calc(50% - 400px);}}@media(max-width:1229px){.col-aside-left-and-sidebar,.col-aside-left-and-sidebar-inner{width:300px;}.col-sidebar,.col-sidebar-inner{width:300px;}.col-content{width:calc(100% - 300px);}.col-content-inner{width:100%;}.col-aside-right,.col-aside-right-inner{display:none;}}@media(max-width:1000px){.col-aside-left-and-sidebar,.col-aside-left-and-sidebar-inner{width:250px;}.col-sidebar,.col-sidebar-inner{width:250px;}.col-content{width:calc(100% - 250px);}}@media(max-width:767px){.col-aside-left-and-sidebar,.col-aside-left-and-sidebar-inner{display:none;}.col-sidebar,.col-sidebar-inner{display:none;}.col-content{width:100%;}.site-main{display:initial;}.site-main .col-sidebar,.site-main .col-sidebar-inner{display:initial;width:100%;position:relative;}.site-main .col-sidebar-overflow{height:calc(30vh);}}.site-header .col-aside-left-and-sidebar-inner,.site-header .col-aside-right-inner,.site-header .col-content-inner{box-shadow:rgba(116,129,141,.1) 0 3px 8px 0;border-bottom:1px solid #d4dadf;}.site-header .col-aside-left-and-sidebar-inner,.site-header .col-aside-right-inner,.site-main .col-aside-left-inner,.site-main .col-sidebar-inner,.site-main .col-aside-right-inner{background:#f5f7f9 none repeat scroll 0% 0%;}.site-header .col-aside-left-and-sidebar-inner,.site-main .col-sidebar-inner{border-right:1px solid #e6ecf1;}.site-header .col-aside-right,.site-main .col-aside-right{border-left:1px solid #e6ecf1;}.brand{font-size:24px;font-weight:bold;height:100%;text-align:right;margin-right:20px;margin-top:10px;}
        </style>
    <link rel="stylesheet" type="text/css" href="../../../styles/master.min0e4d.css?v=todo">
    <!-- to fix/move? -->
    

    
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-55584370-32"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-131737769-1');
    </script>


</head>
<body>


<div class="site-header">
    <div class="col-aside-left-and-sidebar">
        <div class="col-aside-left-and-sidebar-inner">
            <div class="brand">
                <i class="fas fa-yin-yang" style="color: #0056b3;"></i>&nbsp;
                C Language Pedia
            </div>
        </div>
    </div>
    <div class="col-content">
        <div class="col-content-inner">
<div>
    <ul class="list-inline">
        <li class="list-inline-item"><a href="../../../index.html">Tutorial</a></li>
            <li class="list-inline-item"><a href="../../knowledge-base.html">Knowledge-Base</a></li>

            <li class="list-inline-item"><a href="../../awesome-learning/book.html">Awesome</a></li>
    </ul>
</div>

<style>
    .site-header .col-content .list-inline {
        padding-left: 20px;
        padding-top: 15px;

        font-weight: bold;
    }
</style>
        </div>
    </div>
    <div class="col-aside-right">
        <div class="col-aside-right-inner">
            
        </div>
    </div>
</div>
<div class="site-main">
    <div class="col-aside-left">
        <div class="col-aside-left-inner">
            
        </div>
    </div>
    <div class="col-sidebar">
        <div class="col-sidebar-inner">

            <div class="col-sidebar-overflow">
                
            </div>

        </div>
    </div>
    <div class="col-content">
        <div class="col-content-inner">
            


<div id="knowledge-base" class="kb-details">
    <div class="row">
        <div class="col-lg-1 col-xl-1">
        </div>
        <div class="col-lg-9 col-xl-9" itemprop="mainEntity" itemscope itemtype="http://schema.org/Question">
            <div class="container-h1">
                <h1 itemprop="name" id="how-to-concatenate-twice-with-the-c-preprocessor-and-expand-a-macro-as-in-arg-sharpsharp-sharpsharp-macro-">How to concatenate twice with the C preprocessor and expand a macro as in "arg ## _ ## MACRO"?</h1>
                <div class="tag-list">
                        <span class="tag-item"><a href="../tag/c.html">c</a></span>
                        <span class="tag-item"><a href="../tag/concatenation.html">concatenation</a></span>
                        <span class="tag-item"><a href="../tag/c-preprocessor.html">c-preprocessor</a></span>
                        <span class="tag-item"><a href="../tag/token.html">token</a></span>
                </div>
            </div>
            <br>
            <div class="search-results-container">
                <div class="row">
                    <div class="col-sm-6">
                        <div class="block-question">
                            <div class="container-question">
                                <i class="fab fa-stack-overflow" style="font-size: 32px; position: absolute; left: -15px; top: -15px;"></i>
                                <h3 id="question">Question</h3>
                                <div itemprop="text">
                                    <p>I am trying to write a program where the names of some functions are dependent on the value of a certain macro variable with a macro like this:</p>

<pre><code>#define VARIABLE 3
#define NAME(fun) fun ## _ ## VARIABLE

int NAME(some_function)(int a);
</code></pre>

<p>Unfortunately, the macro <code>NAME()</code> turns that into</p>

<pre><code>int some_function_VARIABLE(int a);
</code></pre>

<p>rather than</p>

<pre><code>int some_function_3(int a);
</code></pre>

<p>so this is clearly the wrong way to go about it. Fortunately, the number of different possible values for VARIABLE is small so I can simply do an <code>#if VARIABLE == n</code> and list all the cases separately, but I was wondering if there is a clever way to do it.</p>

                                </div>

                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="profile-container">
                                        <div class="profile-details-container d-flex align-items-center">
                                            <div class="asker-name" itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="https://stackoverflow.com/users/180805/jj-" target="_blank"><span itemprop="name">JJ.</span></a></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: none">
                                    <div itemprop="answerCount">1</div>
                                    <div itemprop="upvoteCount">137</div>
                                    <div itemprop="dateCreated">6/21/2015 9:35:12 AM</div>
                                </div>
                            </div>
                        </div>
                        
                        <br/>
                    </div>
                    <div class="col-sm-6">
                            <div id="answer-0" class="block-question second-answer" itemprop="acceptedAnswer" itemscope itemtype="http://schema.org/Answer">
                                <div class="container-question">
                                    <h3 id="popular-answer">Popular Answer</h3>
                                    <div itemprop="text">
                                        <h3 id="standard-c-preprocessor">Standard C Preprocessor</h3>

<pre><code>$ cat xx.c
#define VARIABLE 3
#define PASTER(x,y) x ## _ ## y
#define EVALUATOR(x,y)  PASTER(x,y)
#define NAME(fun) EVALUATOR(fun, VARIABLE)

extern void NAME(mine)(char *x);
$ gcc -E xx.c
# 1 "xx.c"
# 1 "&lt;built-in&gt;"
# 1 "&lt;command-line&gt;"
# 1 "xx.c"





extern void mine_3(char *x);
$
</code></pre>

<h3 id="two-levels-of-indirection">Two levels of indirection</h3>

<p>In a comment to another answer, <a href="https://stackoverflow.com/users/18255/cade-roux">Cade Roux</a> <a href="https://stackoverflow.com/questions/1489932/c-preprocessor-and-token-concatenation/1489985#comment1342105_1489971">asked</a> why this needs two levels of indirection.  The flippant answer is because that's how the standard requires it to work; you tend to find you need the equivalent trick with the stringizing operator too.</p>

<p>Section 6.10.3 of the C99 standard covers 'macro replacement', and 6.10.3.1 covers 'argument substitution'.</p>

<blockquote>
  <p>After the arguments for the invocation of a function-like macro have been identified,
  argument substitution takes place. A parameter in the replacement list, unless preceded
  by a <code>#</code> or <code>##</code> preprocessing token or followed by a <code>##</code> preprocessing token (see below), is
  replaced by the corresponding argument after all macros contained therein have been
  expanded. Before being substituted, each argument’s preprocessing tokens are
  completely macro replaced as if they formed the rest of the preprocessing file; no other
  preprocessing tokens are available.</p>
</blockquote>

<p>In the invocation <code>NAME(mine)</code>, the argument is 'mine'; it is fully expanded to 'mine'; it is then substituted into the replacement string:</p>

<pre><code>EVALUATOR(mine, VARIABLE)
</code></pre>

<p>Now the macro EVALUATOR is discovered, and the arguments are isolated as 'mine' and 'VARIABLE'; the latter is then fully expanded to '3', and substituted into the replacement string:</p>

<pre><code>PASTER(mine, 3)
</code></pre>

<p>The operation of this is covered by other rules (6.10.3.3 'The ## operator'):</p>

<blockquote>
  <p>If, in the replacement list of a function-like macro, a parameter is immediately preceded
  or followed by a <code>##</code> preprocessing token, the parameter is replaced by the corresponding
  argument’s preprocessing token sequence; [...]</p>
  
  <p>For both object-like and function-like macro invocations, before the replacement list is
  reexamined for more macro names to replace, each instance of a <code>##</code> preprocessing token
  in the replacement list (not from an argument) is deleted and the preceding preprocessing
  token is concatenated with the following preprocessing token.</p>
</blockquote>

<p>So, the replacement list contains <code>x</code> followed by <code>##</code> and also <code>##</code> followed by <code>y</code>; so we have:</p>

<pre><code>mine ## _ ## 3
</code></pre>

<p>and eliminating the <code>##</code> tokens and concatenating the tokens on either side combines 'mine' with '_' and '3' to yield:</p>

<pre><code>mine_3
</code></pre>

<p>This is the desired result.</p>

<hr>

<p>If we look at the original question, the code was (adapted to use 'mine' instead of 'some_function'):</p>

<pre><code>#define VARIABLE 3
#define NAME(fun) fun ## _ ## VARIABLE

NAME(mine)
</code></pre>

<p>The argument to NAME is clearly 'mine' and that is fully expanded.<br>
Following the rules of 6.10.3.3, we find:</p>

<pre><code>mine ## _ ## VARIABLE
</code></pre>

<p>which, when the <code>##</code> operators are eliminated, maps to:</p>

<pre><code>mine_VARIABLE
</code></pre>

<p>exactly as reported in the question.</p>

<hr>

<h3 id="traditional-c-preprocessor">Traditional C Preprocessor</h3>

<p><a href="https://stackoverflow.com/users/1746785/robert-rüger">Robert Rüger</a> <a href="https://stackoverflow.com/questions/1489932/how-to-concatenate-twice-with-the-c-preprocessor-and-expand-a-macro-as-in-arg/1489985?noredirect=1#comment69821433_1489985">asks</a>:</p>

<blockquote>
  <p>Is there any way do to this with the traditional C preprocessor which does not have the token pasting operator <code>##</code>?</p>
</blockquote>

<p>Maybe, and maybe not — it depends on the preprocessor.  One of the advantages of the standard preprocessor is that it has this facility which works reliably, whereas there were different implementations for pre-standard preprocessors.  One requirement is that when the preprocessor replaces a comment, it does not generate a space as the ANSI preprocessor is required to do.  The GCC (6.3.0) C Preprocessor meets this requirement; the Clang preprocessor from XCode 8.2.1 does not.</p>

<p>When it works, this does the job (<code>x-paste.c</code>):</p>

<pre><code>#define VARIABLE 3
#define PASTE2(x,y) x/**/y
#define EVALUATOR(x,y) PASTE2(PASTE2(x,_),y)
#define NAME(fun) EVALUATOR(fun,VARIABLE)

extern void NAME(mine)(char *x);
</code></pre>

<p>Note that there isn't a space between <code>fun,</code> and <code>VARIABLE</code> — that is important because if present, it is copied to the output, and you end up with <code>mine_ 3</code> as the name, which is not syntactically valid, of course.  (Now, please can I have my hair back?)</p>

<p>With GCC 6.3.0 (running <code>cpp -traditional x-paste.c</code>), I get:</p>

<pre><code># 1 "x-paste.c"
# 1 "&lt;built-in&gt;"
# 1 "&lt;command-line&gt;"
# 1 "x-paste.c"





extern void mine_3(char *x);
</code></pre>

<p>With Clang from XCode 8.2.1, I get:</p>

<pre><code># 1 "x-paste.c"
# 1 "&lt;built-in&gt;" 1
# 1 "&lt;built-in&gt;" 3
# 329 "&lt;built-in&gt;" 3
# 1 "&lt;command line&gt;" 1
# 1 "&lt;built-in&gt;" 2
# 1 "x-paste.c" 2





extern void mine _ 3(char *x);
</code></pre>

<p>Those spaces spoil everything.  I note that both preprocessors are correct; different pre-standard preprocessors exhibited both behaviours, which made token pasting an extremely annoying and unreliable process when trying to port code.  The standard with the <code>##</code> notation radically simplifies that.</p>

<p>There might be other ways to do this.  However, this does not work:</p>

<pre><code>#define VARIABLE 3
#define PASTER(x,y) x/**/_/**/y
#define EVALUATOR(x,y) PASTER(x,y)
#define NAME(fun) EVALUATOR(fun,VARIABLE)

extern void NAME(mine)(char *x);
</code></pre>

<p>GCC generates:</p>

<pre><code># 1 "x-paste.c"
# 1 "&lt;built-in&gt;"
# 1 "&lt;command-line&gt;"
# 1 "x-paste.c"





extern void mine_VARIABLE(char *x);
</code></pre>

<p>Close, but no dice.  YMMV, of course, depending on the pre-standard preprocessor that you're using.  Frankly, if you're stuck with a preprocessor that is not cooperating, it would probably be simpler to arrange to use a standard C preprocessor in place of the pre-standard one (there is usually a way to configure the compiler appropriately) than to spend much time trying to work out a way to do the job.</p>

                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="profile-container">
                                            <div class="profile-details-container d-flex align-items-center">
                                                    <div class="asker-name" itemprop="author" itemscope itemtype="https://schema.org/Person">
                                                        <a href="https://stackoverflow.com/users/15168/jonathan-leffler" target="_blank"><span itemprop="name">Jonathan Leffler</span></a>
                                                    </div>
                                            </div>
                                        </div>
                                    </div>
                                        <div style="display: none">
                                            <div itemprop="url">https://c.programmingpedia.net/en/knowledge-base/1489932/how-to-concatenate-twice-with-the-c-preprocessor-and-expand-a-macro-as-in--arg-sharpsharp---sharpsharp-macro--#answer-0</div>
                                            <div itemprop="upvoteCount">205</div>
                                            <div itemprop="dateCreated">5/23/2017 11:47:13 AM</div>
                                        </div>
                                </div>
                            </div>
                            <br/>
                    </div>
                </div>
                <div class="text-center mt-5 mb-5">
                    <a href="https://stackoverflow.com/questions/1489932" class="btn-only d-inline-block stack-overflow-identity" target="_blank"><i class="fab fa-stack-overflow"></i> View more on Stack Overflow</a>
                </div>
            </div>
            
            <div class="attribution">
                <div>Licensed under: <a href="https://creativecommons.org/licenses/by-sa/3.0/" target="_blank">CC-BY-SA</a> with <a href="https://stackoverflow.blog/2009/06/25/attribution-required/" target="_blank">attribution</a></div>
                <div>Not affiliated with: <a href="https://stackoverflow.com/questions/tagged/dapper" target="_blank">Stack Overflow</a></div>
                
            </div>
        </div>

    </div>
</div>
            
        </div>
    </div>
    <div class="col-aside-right">
        <div class="col-aside-right-inner">
        </div>
    </div>
</div>
<div class="site-footer">
</div>
    
    <a href="#" id="scroll-to-top" class="back-to-top" style="display: inline;">Icon</a>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="http://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

<script>
    $(function() {
        $('a').each(function() {
            var a = new RegExp('/' + window.location.host + '/');
            if (!a.test(this.href)) {
                $(this).attr("target", "_blank");
            }
        });

        $("table").addClass("table table-bordered table-hover table-responsive-sm table-striped");
        $("thead").addClass("thead-dark");

        $('aside a').each(function() {
            if ($(this).attr('href') == '/{{page.permalink}}' ||
                $(this).attr('href') == '{{ site.github.url }}/{{page.permalink}}') {
                $(this).addClass('font-weight-bold');
            }
        });
    });
</script>


</body>

<!-- Mirrored from c.programmingpedia.net/en/knowledge-base/1489932/how-to-concatenate-twice-with-the-c-preprocessor-and-expand-a-macro-as-in--arg-sharpsharp---sharpsharp-macro-- by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Jan 2021 09:51:37 GMT -->
</html>
